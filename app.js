function createChart(e){if(e){var t=e.Dates.map(function(t,n){return{date:new Date(t),close:+e.Elements[0].DataSeries.close.values[n]}});savedData=t}else t=savedData;var n=getBollinger(t,+document.getElementById("maPeriod").value,+document.getElementById("stddev").value);x.domain([t[0].date,t[t.length-1].date]);var a=Math.min(d3.min(n,function(e){return e.lower}),d3.min(t,function(e){return e.close})),r=Math.max(d3.max(n,function(e){return e.upper}),d3.max(t,function(e){return e.close}));y.domain([a,r]),d3.select(".x").call(xAxis),d3.select(".y").transition().call(yAxis),d3.select(".ma").datum(n).transition().attr("d",line("ma")),d3.select(".close").datum(t).transition().attr("d",line("close")),d3.select(".area").datum(n).transition().attr("d",bandsArea),d3.select(".y text").text("Price $")}function getBollinger(e,t,n){return void 0===t&&(t=20),void 0===n&&(n=2),d3.range(0,e.length-t).map(function(a){var r=a+t-1,i=e.slice(a,r),d=d3.mean(i,function(e){return e.close}),o=Math.sqrt(d3.mean(i.map(function(e){return Math.pow(e.close-d,2)})));return{date:e[r].date,ma:d,lower:d-n*o,upper:d+n*o}})}var getUrl=function(e){return'http://dev.markitondemand.com/MODApis/Api/v2/InteractiveChart/jsonp?parameters={"Normalized":false,"NumberOfDays":365,"DataPeriod":"Day","Elements":[{"Symbol":"'+e+'","Type":"price","Params":["c"]}]}'};d3.select("#stockInput").on("keydown",function(){if(13===d3.event.keyCode){var e=getUrl(document.getElementById("stockInput").value);fetchJsonp(e).then(function(e){return e.json()}).then(createChart)}});var height=+d3.select("svg").attr("height")-50,width=+d3.select("svg").attr("width")-70,x=d3.time.scale().range([0,width]),y=d3.scale.linear().range([height,0]),xAxis=d3.svg.axis().scale(x).innerTickSize(-height).orient("bottom").tickFormat(d3.time.format("%B")),yAxis=d3.svg.axis().scale(y).innerTickSize(-width).orient("left"),line=function(e){return d3.svg.line().x(function(e){return x(e.date)}).y(function(t){return y(t[e])})},bandsArea=d3.svg.area().x(function(e){return x(e.date)}).y0(function(e){return y(e.lower)}).y1(function(e){return y(e.upper)}),savedData;d3.selectAll("select").on("change",createChart);